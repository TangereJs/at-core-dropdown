<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="at-core-dropdown-impl.html" />

<dom-module id="at-core-dropdown">
  <template>
    <style>
       :host {
        display: block;
        box-sizing: border-box;
      }
    </style>

    <at-core-dropdown-impl id$="[[_computeImplId()]]" position="[[position]]" x-offset="[[xOffset]]" y-offset="[[yOffset]]" open="{{open}}" on-open-changed="_handleOpenChanged">
      <content></content>
    </at-core-dropdown-impl>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-core-dropdown',
      properties: {
        position: {
          type: String,
          value: "bottomLeft",
          xtype: "enum",
          xvaluelist: [{
            title: "Top Left",
            value: "topLeft"
          }, {
            title: "Top Right",
            value: "topRight"
          }, {
            title: "Bottom Left",
            value: "bottomLeft"
          }, {
            title: "Bottom Right",
            value: "bottomRight"
          }]
        },

        /**
         * Positive value moves element to the right. Negative value moves element to the left
         * 
         * @property xOffset
         * @type Number
         * @default 0
         */
        xOffset: {
          type: Number,
          value: 0
        },

        /**
         * Positive value moves element to the top. Negative value moves element to the bottom
         * 
         * @property yOffset
         * @type Number
         * @default 0
         */
        yOffset: {
          type: Number,
          value: 0
        },

        /**
         * True when dropdown is open, false otherwise
         * set to true to open the dropdown, set to false to close it
         * 
         * @property open
         * @type Boolean
         * @default false
         */
        open: {
          type: Boolean,
          value: false,
          notify: true
        }
      },

      $meta: [{
        playground: false // disable playground for this element
      }],

      attached: function() {
        this._boundWindowResizeHandler = this._windowResizeHandler.bind(this);
        window.addEventListener('resize', this._boundWindowResizeHandler);
        // orientation change only works on mobile devices
        window.addEventListener('orientationchange', this._boundWindowResizeHandler);
      },

      detached: function() {
        window.removeEventListener('resize', this._boundWindowResizeHandler);
        window.removeEventListener('orientationchange', this._boundWindowResizeHandler);
      },

      _windowResizeHandler: function(event) {
        this.hide();
      },

      _handleOpenChanged: function(newValue, oldValue) {
        var impl = this._getImplElement();
        if (impl.open) return;

        // if dropdown is already removed from body return
        if (this.contains(impl)) return;

        // dropdown is closed; remove from body
        document.body.removeChild(impl);
        this.appendChild(impl);
      },

      _computeImplId: function() {
        var parentId = this.getAttribute('id');
        parentId = parentId ? parentId : 'parent';
        var rndNum = Math.floor(Math.random(1000, 9999) * 10000);
        var implId = this._implId = 'impl' + rndNum + parentId;
        return implId;
      },

      _getImplElement: function() {
        if (this.__implElement) return this.__implElement;

        var selector = '#' + this._implId;
        var implElement = this.__implElement = this.$$(selector);
        return implElement;
      },

      isOpen: function() {
        return this._getImplElement().open;
      },

      toggle: function(relativeTo, evt) {
        var dropdown = this._getImplElement();

        if (dropdown.open) {
          // dropdown will be closed; remove from body
          document.body.removeChild(dropdown);
          this.appendChild(dropdown);
        } else {
          // dropdown will be opened; append to body
          this.removeChild(dropdown);
          document.body.appendChild(dropdown);
        }

        dropdown.toggle(relativeTo, evt);
      },

      show: function(evt, relativeTo) {
        var impl = this._getImplElement();
        if (impl.open) return;

        // dropdown will be opened; append to body
        this.removeChild(impl);
        document.body.appendChild(impl);

        impl.show(evt, relativeTo);
      },

      hide: function() {
        var impl = this._getImplElement();
        if (!impl.open) return;

        // dropdown will be closed; remove from body
        document.body.removeChild(impl);
        this.appendChild(impl);

        impl.hide();
      }

    });
  </script>
</dom-module>
